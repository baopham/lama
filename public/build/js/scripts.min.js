"use strict";angular.element(document).ready(function(){angular.bootstrap(document,["lama"])}),angular.module("lama",["ui.router","restangular","lama.system","lama.users"]),angular.module("lama.system",[]).config(["$httpProvider",function($httpProvider){$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]).run(["$rootScope","$state","$log","Global",function($rootScope,$state,$log,Global){$rootScope.$state=$state,$rootScope.$log=$log,$rootScope.global=Global}]),angular.module("lama.system").controller("HeaderController",["$scope","$rootScope","Menus",function($scope,$rootScope,Menus){function queryMenu(menus){Menus.query(menus).then(function(result){$scope.menus=result.data},function(reason){throw new Error(reason)})}var menus=[{permission:null,title:"Home",link:"home"},{permission:"users",title:"User",link:"user_actions.list"}];queryMenu(menus),$rootScope.$on("loggedin",function(){queryMenu(menus),$scope.global={user:$rootScope.global.user,authenticated:$rootScope.global.user.groups.length,isAdmin:$rootScope.global.user.groups.indexOf("Admins")}})}]),angular.module("lama.system").directive("lmUserFeedback",function(){return{require:"ngModel",restrict:"A",link:function(scope,element,attrs,ctrl){var $parentDiv=element.parent(),currentClass=$parentDiv.attr("class");element.on("blur",function(){$parentDiv.removeClass(),$parentDiv.addClass(currentClass),$parentDiv.addClass(ctrl.$valid?"has-success":"has-error")})}}}).directive("lmEquals",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModelCtrl){function validateEqual(myValue){var valid=myValue===scope.$eval(attrs.lmEquals);return ngModelCtrl.$setValidity("lmequals",valid),valid?myValue:void 0}ngModelCtrl.$parsers.push(validateEqual),ngModelCtrl.$formatters.push(validateEqual),scope.$watch(attrs.validateEquals,function(){ngModelCtrl.$setViewValue(ngModelCtrl.$viewValue)})}}}).directive("lmLoader",function(){var tpl='<div id="loading"><i class="fa fa-spinner fa-spin fa-4x"></i></div>';return{restrict:"A",scope:{condition:"&"},link:function(scope,element){element.css("position","relative"),scope.$watch("condition()",function(){var isSubmitted=scope.condition();isSubmitted?element.append(tpl):$("#loading").remove()})}}}),angular.module("lama.system").filter("tsToDate",function($filter){return function(input,format){return $filter("date")(Date.parse(input.split(" ").shift()),format)}}),angular.module("lama.system").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"system/views/home.html"})}]).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.module("lama.system").factory("Global",[function(){var data={user:window.user,authenticated:!1,isAdmin:!1};return data.user&&data.user.groups&&(data.authenticated=data.user.groups.length,data.isAdmin=~data.user.groups.indexOf("Admins")),data}]),angular.module("lama.system").factory("httpInterceptor",["$q","$location",function($q,$location){return{response:function(response){return 401===response.status?($location.url("/user/signin"),$q.reject(response)):403===response.status?($location.url("/"),$q.reject(response)):response||$q.when(response)},responseError:function(rejection){return 401===rejection.status?($location.url("/user/signin"),$q.reject(rejection)):403===rejection.status?($location.url("/"),$q.reject(rejection)):$q.reject(rejection)}}}]).config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("httpInterceptor")}]),angular.module("lama.system").factory("Menus",["$http",function($http){return{query:function(menus){return $http.get("/api/v1/user/menus",{params:{"menus[]":menus}})}}}]),angular.module("lama.system").factory("Paginator",function(){return function(pageSize,navRange,data){var cache=[],hasNext=!1,currentOffset=0,numOfItemsXpage=pageSize,pageRange=navRange,numOfItems=0,totPages=0,currentPage=1,end=0,start=0,delta=1,load=function(){cache=data,numOfItems=cache.length,hasNext=numOfItems>numOfItemsXpage,totPages=Math.ceil(numOfItems/numOfItemsXpage),pageRange>totPages&&(pageRange=totPages),loadFromCache()},loadFromCache=function(){if(paginator.items=cache.slice(currentOffset,numOfItemsXpage*currentPage),delta=Math.ceil(pageRange/2),currentPage-delta>totPages-pageRange)start=totPages-pageRange+1,end=totPages+1;else{0>currentPage-delta&&(delta=currentPage);var offset=currentPage-delta;start=offset+1,end=offset+pageRange+1}hasNext=numOfItems>currentPage*numOfItemsXpage},paginator={items:[],hasNext:function(){return hasNext},hasPrevious:function(){return 0!==currentOffset},hasFirst:function(){return 1!==currentPage},hasLast:function(){return totPages>2&&currentPage!==totPages},next:function(){this.hasNext()&&(currentPage++,currentOffset+=numOfItemsXpage,loadFromCache())},previous:function(){this.hasPrevious()&&(currentPage--,currentOffset-=numOfItemsXpage,loadFromCache())},toPageId:function(num){currentPage=num,currentOffset=(num-1)*numOfItemsXpage,loadFromCache()},first:function(){this.toPageId(1)},last:function(){this.toPageId(totPages)},getNumOfItems:function(){return numOfItems},getCurrentPage:function(){return currentPage},getEnd:function(){return end},getStart:function(){return start},getTotPages:function(){return totPages},getNumOfItemsXpage:function(){return numOfItemsXpage}};return load(),paginator}}).filter("pagination",function(){return function(input,start,end){start=parseInt(start,10),end=parseInt(end,10);for(var i=start;end>i;i++)input.push(i);return input}}),angular.module("lama.system").factory("Restify",["Restangular",function(Restangular){return function(route){var elements=Restangular.all(route);return{get:function(id){return Restangular.one(route,id).get()},getList:function(){return elements.getList()},post:function(data){return elements.post(data)},copy:function(original){return Restangular.copy(original)},all:function(route){return Restangular.all(route)},one:function(id){return Restangular.one(route,id)},getElements:function(){return elements}}}}]),angular.module("lama.users",[]),angular.module("lama.users").controller("SessionSigninCtrl",["$scope","$rootScope","$http","$state",function($scope,$rootScope,$http,$state){$scope.user={},$scope.error=null,$scope.save=function(){$http.post("/api/v1/signin",$scope.user).then(function(response){var data=response.data;return data.success?($rootScope.global.user=data.user,$rootScope.$emit("loggedin"),$state.go("home")):void($scope.errors=data.errors)})}}]).controller("SessionRegisterCtrl",["$rootScope","$scope","$state","User",function($rootScope,$scope,$state,User){$scope.user={},$scope.errors=null,$scope.isSubmitted=!1,$scope.save=function(){$scope.isSubmitted=!0,User.post($scope.user).then(function(data){return data.success?data.logged>0?($rootScope.global.user=data.user,$rootScope.$emit("loggedin"),$state.go("home")):$state.go("session.register-thanks"):($scope.errors=data.errors,void($scope.isSubmitted=!1))})},$scope.registerLoading=function(){return $scope.isSubmitted}}]).controller("SessionForgotPasswordCtrl",["$scope","$state","User",function($scope,$state,User){$scope.user={},$scope.errors=null,$scope.save=function(){User.forgot($scope.user).then(function(data){return data.success?$state.go("session.forgot-thanks"):void($scope.errors=data.errors)})}}]),angular.module("lama.users").controller("UserCtrl",["$scope","$state","users","User","Paginator","CurrentPageMemory",function($scope,$state,users,User,Paginator,CurrentPageMemory){$scope.hasUsers=users.length>0,$scope.paginator=Paginator(2,5,users),CurrentPageMemory.get()>1&&$scope.paginator.toPageId(CurrentPageMemory.get()),$scope.unSuspend=function(id){var unsuspend=User.unsuspend(id);unsuspend.put().then(function(){return CurrentPageMemory.set($scope.paginator.getCurrentPage()),$state.go("user_actions.list",{},{reload:!0})},function(reason){throw new Error(reason)})}}]).controller("UserInnerCtrl",["$scope","$filter",function($scope,$filter){$scope.user.created_at=$filter("tsToDate")($scope.user.created_at,"shortDate"),$scope.user.showSuspend=$scope.user.active&&!$scope.user.banned,$scope.user.showUnSuspend=!$scope.user.active&&!$scope.user.banned}]).controller("UserParentActionsCtrl",["$scope",function($scope){$scope.someSelected=function(object){return Object.keys(object).some(function(key){return object[key]})}}]).controller("UserCreateCtrl",["$scope","$state","groups","User",function($scope,$state,groups,User){$scope.groups=groups,$scope.user={},$scope.user.groups={},$scope.errors=null,$scope.save=function(){$scope.user.groups=Object.keys($scope.user.groups),User.register($scope.user).then(function(data){return data.success?$state.go("user_actions.list"):($scope.errors=data.errors,void($scope.user.groups={}))})}}]).controller("UserSuspendCtrl",["$scope","$state","user","User","CurrentPageMemory",function($scope,$state,user,User,CurrentPageMemory){$scope.user={};var suspend=User.suspend(user.id);$scope.errors=null,$scope.save=function(){suspend.minutes=$scope.user.minutes,suspend.put().then(function(data){return data.success?(CurrentPageMemory.set($state.params.page),$state.go("user_actions.list")):void($scope.errors=data.errors)})}}]).controller("UserEditCtrl",["$scope","$state","groups","user","User",function($scope,$state,groups,user,User){$scope.groups=groups,$scope.user=user;var userHasGroup={};angular.forEach($scope.user.groups,function(value){var hasGroup=_.find($scope.groups,function(group){return group.id===value.id});hasGroup&&(userHasGroup[value.id]=!0)},userHasGroup),$scope.user.groups=userHasGroup;var edit=User.edit($scope.user.id);$scope.errors=null,$scope.save=function(){edit.fullname=$scope.user.fullname,edit.email=$scope.user.email,edit.username=$scope.user.username,angular.forEach($scope.user.groups,function(value,key){value||delete $scope.user.groups[key]}),edit.groups=$scope.user.groups,edit.put().then(function(data){return data.success?$state.go("user_actions.list"):($scope.errors=data.errors,void($scope.user.groups={}))})}}]).controller("UserDeleteCtrl",["$scope","$state","user",function($scope,$state,user){$scope.save=function(){return $state.go("user_actions.list")},$scope.destroy=function(){user.remove().then(function(){return $state.go("user_actions.list")},function(reason){throw new Error(reason)})}}]).controller("UserAccountCtrl",["$rootScope","$scope","$state","user","User",function($rootScope,$scope,$state,user,User){$scope.user=user;var account=User.account($scope.user.id);$scope.errors=null,$scope.save=function(){account.fullname=$scope.user.fullname,account.email=$scope.user.email,account.username=$scope.user.username,account.put().then(function(data){return data.success?($rootScope.global.user.fullname=data.user.fullname,$state.go("home")):void($scope.errors=data.errors)})}}]).controller("UserPasswordCtrl",["$rootScope","$scope","$state","user","User",function($rootScope,$scope,$state,user,User){$scope.user={};var password=User.password(user.id);$scope.errors=null,$scope.save=function(){password.old_password=$scope.old_password,password.password=$scope.user.password,password.password_confirmation=$scope.user.password_confirmation,password.put().then(function(data){return data.success?$state.go("home"):void($scope.errors=data.errors)})}}]).factory("CurrentPageMemory",function(){var current=1;return{get:function(){return current},set:function(num){current=num}}}),angular.module("lama.users").directive("userManagerStatus",function(User){return{restrict:"A",scope:{userData:"="},controller:function($scope){$scope.ban=function(id){var ban=User.ban(id);return ban.put()},$scope.unBan=function(id){var unban=User.unban(id);return unban.put()}},link:function(scope,element){var status=scope.userData.status;element.text("Banned"===status?"Un-ban":"Ban"),element.on("click",function(e){e.stopPropagation(),"Banned"===status?scope.unBan(scope.userData.id).then(function(){$("#user-status-"+scope.userData.id).text("Active"),scope.userData.status="Active",element.text("Ban")},function(reason){throw new Error(reason)}):scope.ban(scope.userData.id).then(function(){$("#user-status-"+scope.userData.id).text("Banned"),scope.userData.status="Banned",element.text("Un-ban")},function(reason){throw new Error(reason)})})}}}),angular.module("lama.users").config(["$stateProvider",function($stateProvider){$stateProvider.state("session",{"abstract":!0,templateUrl:"users/views/session.html",resolve:{issessionedin:function(Session){return Session.isSessionedIn()}}}).state("session.signin",{url:"/user/signin",templateUrl:"users/views/signin.html",controller:"SessionSigninCtrl"}).state("session.register",{url:"/user/register",templateUrl:"users/views/register.html",controller:"SessionRegisterCtrl"}).state("session.password",{url:"/user/forgot-password",templateUrl:"users/views/forgot-password.html",controller:"SessionForgotPasswordCtrl"}).state("session.register-thanks",{url:"/user/register-thanks",templateUrl:"users/views/register-thanks.html"}).state("session.forgot-thanks",{url:"/user/forgot-thanks",templateUrl:"users/views/forgot-thanks.html"})}]),angular.module("lama.users").config(["$stateProvider",function($stateProvider){$stateProvider.state("users",{"abstract":!0,templateUrl:"users/views/users.html",resolve:{issessionedin:function(Session){return Session.isLoggedIn()}}}).state("users.account",{url:"/user/account/:id",templateUrl:"users/views/account.html",resolve:{user:function(User,$stateParams){return User.get($stateParams.id)}},controller:"UserAccountCtrl"}).state("users.password",{url:"/user/password/:id",templateUrl:"users/views/password.html",resolve:{user:function(User,$stateParams){return User.get($stateParams.id)}},controller:"UserPasswordCtrl"}).state("user_actions",{"abstract":!0,templateUrl:"users/views/actions.html",resolve:{hasaccess:function(Session){return Session.hasAccess("users")}},controller:"UserParentActionsCtrl"}).state("user_actions.create",{url:"/user/create",templateUrl:"users/views/create.html",resolve:{groups:function(Group){return Group.getList()}},controller:"UserCreateCtrl"}).state("user_actions.list",{url:"/users",templateUrl:"users/views/index.html",resolve:{users:function(User){return User.getList()}},controller:"UserCtrl"}).state("user_actions.suspend",{url:"/user/:id/suspend/page/:page",templateUrl:"users/views/suspend.html",resolve:{user:function(User,$stateParams){return User.get($stateParams.id)}},controller:"UserSuspendCtrl"}).state("user_actions.edit",{url:"/user/:id/edit",templateUrl:"users/views/edit.html",resolve:{groups:function(Group){return Group.getList()},user:function(User,$stateParams){return User.get($stateParams.id)}},controller:"UserEditCtrl"}).state("user_actions.delete",{url:"/user/:id/delete",templateUrl:"users/views/delete.html",resolve:{user:function(User,$stateParams){return User.get($stateParams.id)}},controller:"UserDeleteCtrl"})}]),angular.module("lama.users").factory("Session",["$http",function($http){return{isSessionedIn:function(){$http.get("/api/v1/issessionedin")},isLoggedIn:function(){$http.get("/api/v1/isloggedin")},hasAccess:function(permission){$http.get("/api/v1/hasaccess/"+permission)}}}]),angular.module("lama.users").config(["RestangularProvider",function(RestangularProvider){RestangularProvider.setBaseUrl("/api/v1")}]).factory("User",["Restify",function(Restify){function User(){this.account=function(id){return this.one(id).one("account")},this.password=function(id){return this.one(id).one("password")},this.register=function(data){return this.all("user/create").post(data)},this.forgot=function(data){return this.all("user/forgot").post(data)},this.edit=function(id){return this.one(id).one("edit")},this.suspend=function(id){return this.one(id).one("suspend")},this.unsuspend=function(id){return this.one(id).one("unsuspend")},this.ban=function(id){return this.one(id).one("ban")},this.unban=function(id){return this.one(id).one("unban")}}return angular.extend(Restify("user"),new User)}]).factory("Group",["Restify",function(Restify){function Group(){}return angular.extend(Restify("group"),new Group)}]);